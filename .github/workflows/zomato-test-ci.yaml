name: Windows CI Pipeline for Zomato Project

on:
  push:
    branches:
      - feature-*  # Runs on any feature branch like feature-zomato-test

jobs:
  build:
    runs-on: windows-latest  # Using Windows runner

    env:
      DOCKER_IMAGE: devopsship/zomato:latest  # Change if needed

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install NPM Dependencies
        run: npm install

      - name: Start SonarQube (Optional)
        run: |
          Start-Process -FilePath "C:\Dev-tools\sonarqube-25.2.0.102705\bin\windows-x86-64\StartSonar.bat"
          Start-Sleep -s 30  # Wait for SonarQube to start

      - name: SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner.bat ^
            -Dsonar.projectKey=zomato ^
            -Dsonar.projectName=zomato ^
            -Dsonar.host.url=http://localhost:9000 ^
            -Dsonar.token=%SONAR_TOKEN%

      - name: Set Up Docker
        run: |
          echo "Enabling Docker"
          Start-Service docker

      - name: Log in to Docker Hub
        run: echo ${{ secrets.DOCKER_HUB_PASSWORD }} | docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin

      - name: Build Docker Image
        run: docker build -t $env:DOCKER_IMAGE .

      - name: Push Docker Image to Docker Hub
        run: docker push $env:DOCKER_IMAGE
