name: Windows CI Pipeline for Zomato Project

on:
  push:
    branches:
      - feature-*  # Runs on any feature branch like feature-zomato-test

jobs:
  build:
    runs-on: windows-latest  # Using Windows runner

    env:
      DOCKER_IMAGE: devopsship/zomato:latest  # Change if needed

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install NPM Dependencies
        run: npm install

      - name: Install Trivy (Security Scanner)
        run: |
          iwr -Uri "https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Windows-64bit.zip" -OutFile "trivy.zip"
          Expand-Archive -Path "trivy.zip" -DestinationPath "C:\trivy"
          echo "C:\trivy" >> $env:GITHUB_PATH
          setx PATH "C:\trivy;%PATH%"

      - name: Run Trivy Security Scan
        run: C:\trivy\trivy.exe fs --exit-code 0 --severity HIGH,CRITICAL --format table --output trivy-report.txt .

      - name: Set Up SonarQube Scanner
        run: |
          Invoke-WebRequest -Uri "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-windows.zip" -OutFile "sonar.zip"
          Expand-Archive -Path "sonar.zip" -DestinationPath "C:\sonar-scanner"
          echo "C:\sonar-scanner\sonar-scanner-5.0.1.3006-windows\bin" >> $env:GITHUB_PATH
          setx PATH "C:\sonar-scanner\sonar-scanner-5.0.1.3006-windows\bin;%PATH%"

      - name: Start SonarQube Server (Optional)
        run: |
          docker run -d --name sonar -p 9000:9000 sonarqube:lts
          Start-Sleep -s 30  # Wait for SonarQube to start

      - name: SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          C:\sonar-scanner\sonar-scanner.bat ^
            -Dsonar.projectKey=zomato ^
            -Dsonar.projectName=zomato ^
            -Dsonar.host.url=http://localhost:9000 ^
            -Dsonar.token=%SONAR_TOKEN%

      - name: Set Up Docker
        run: |
          echo "Enabling Docker"
          Start-Service docker

      - name: Log in to Docker Hub
        run: echo ${{ secrets.DOCKER_HUB_PASSWORD }} | docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin

      - name: Build Docker Image
        run: docker build -t $env:DOCKER_IMAGE .

      - name: Push Docker Image to Docker Hub
        run: docker push $env:DOCKER_IMAGE
